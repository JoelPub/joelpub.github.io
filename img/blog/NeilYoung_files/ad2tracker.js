class Ad2Tracker{constructor(){this.init()}init(){this.config={eventTypes:["click","dblclick","contextmenu"],eventsSelector:"a, button",searchEvtSelector:'[type="search"]',metaInclude:"og:type, og:title, og:description, keywords, description, article:tag, article:publisher, article:section",microDataAllowed:"headline, description, author, datePublished, dateModified, keywords",snsEvtSelector:"*[data-at-sns]",customizeEvt:["purchase","cart","follow","signin","login","logout","submit","search","click","share"]},this.bindedSelector=this.config.eventsSelector,this.location={url:location.href,title:document.querySelector("title").innerText},this.obqueue(),this.getudid()}getudid(){const e=this,t=this.constant.idName;function n(){e.cookie.set(t,e.udid,99999);const n=document.createElement("iframe");n.name="ad2tracker-set-udid",n.style.cssText="height: 0; overflow: hidden; border: 0; opacity: 0; visibility: hidden;",n.onload=function(){},n.src=e.constant.iframeURL+"?ad2udid="+e.udid,document.body.append(n),e.pagelife(),e.events()}new Promise((t,n)=>{const i=document.createElement("iframe");window.addEventListener("message",o=>{if(/content\.ad2iction\.com/.test(o.origin)){if(""===o.data)return!1;const a="string"==typeof o.data?JSON.parse(o.data):o.data;e.udid=a.hasOwnProperty("udid")&&/[a-z\d]{14}\.[a-z\d]{40}/.test(a.udid)?a.udid:"",i.remove(),""!==e.udid?t():n()}}),i.addEventListener("error",e=>{n()}),i.name="ad2tracker-get-udid",i.src=e.constant.iframeURL,i.style.cssText="height: 0; overflow: hidden; border: 0; opacity: 0; visibility: hidden;",document.body.append(i)}).then(n).catch(i=>{(function(){const n=location.search.substring(1),i=""!==n?JSON.parse('{"'+decodeURI(n).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}'):{};return new Promise((n,o)=>{i.hasOwnProperty(t)?e.udid=i[t]:e.udid=e.cookie.get(t),""!==e.udid?n():o()})})().then(n).catch(t=>{!function(){if(""==location.hostname)return!1;const t=new XMLHttpRequest;t.addEventListener("load",i=>{e.udid=JSON.parse(t.response).id,n()}),t.addEventListener("error",n),t.open("GET",e.constant.udidURL),t.send()}()})})}obqueue(){const e=this;this._gv=window.Ad2TrackerObject,window[this._gv].q.forEach(e=>{try{const t=Array.from(e),n=t.shift();this.cmd[n].bind(this)(t)}catch(e){console.log(e)}}),Object.defineProperty(window[this._gv].q,"push",{configurable:!0,enumerable:!0,writable:!0,value:function(){let t,n,i;for(t=0,n=this.length,i=arguments.length;t<i;t++,n++){this[n]=arguments[t];try{const t=Array.from(arguments[0]),n=t.shift();e.cmd[n].bind(e)(t)}catch(e){console.log(e)}}return n}})}pagelife(){const e=document.body,t=document.documentElement;this.ph=Math.max(e.scrollHeight,e.offsetHeight,t.clientHeight,t.scrollHeight,t.offsetHeight),this.pageinfo=this.pageinfo();const n={...this.pageinfo,action:"enter",ref:document.referrer?document.referrer:null};let i={action:"leave"};this.sendbeacon(n);let o=!1;function a(){const e=(document.body.scrollTop||document.documentElement.scrollTop)+window.innerHeight;i.viewed=Math.floor(e/this.ph*100)+"%"}["beforeunload","unload","pagehide"].forEach(e=>{addEventListener(e,t=>{if(o)return!1;a.call(this),i.method=e,this.sendbeacon(i),o=!0})}),document.addEventListener("visibilitychange",e=>{if("hidden"==document.visibilityState){if(o)return!1;a.call(this),i.method="visibilitychange",this.sendbeacon(i),o=!0}}),window.addEventListener("focus",e=>{this.sendbeacon(n),o=!1})}pageinfo(){const e=this;return{get meta(){const t=document.querySelectorAll("meta"),n=e.config.metaInclude.replace(/\s/g,"").split(",");let i=t?{}:"";return t.forEach(e=>{const t=""!==e.name?e.name:e.getAttribute("property");null!==t&&-1!==n.indexOf(t)&&(i[t]=i.hasOwnProperty(t)?i[t]+","+e.content:e.content)}),i},get strdata(){const t=e.config.microDataAllowed.replace(/\s/g,"").split(","),n=document.querySelectorAll("*[data-at-strdata]");let i=n?{}:"";return n.forEach(e=>{const n=e.dataset.atStrdata;if(-1!==t.indexOf(n)){let t,o=[];const a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);for(;t=a.nextNode();){const e=t.nodeValue.replace(/[\n\r]+|[\s]{2,}/g,"").trim();""!==e&&o.push(e)}i[n]=i.hasOwnProperty(n)?i[n].concat(o):o}}),i},get schema(){const e=document.querySelector('script[type="application/ld+json"]');return e?JSON.parse(e.innerText):""}}}events(){const e={url:this.pageinfo.url,title:this.pageinfo.title};function t(t,n){const i=n.href;let o={action:t.type,tagName:n.tagName.toLowerCase(),innerText:n.innerText};i?(o.href=i,i.match(/www.facebook.com\/dialog\/share/)?this.sendbeacon({...e,innerText:n.innerText,platform:"facebook",action:"share"}):i.match(/twitter.com\/intent\/tweet/)&&!window.twttr?this.sendBeacon({...e,innerText:n.innerText,platform:"twitter",action:"share"}):this.sendbeacon(o)):this.sendbeacon(o)}this.activeElm=null,this.config.eventTypes.forEach(e=>{document.querySelectorAll(`body, ${this.config.eventsSelector}`).forEach(n=>{n.addEventListener(e,this.active.bind(this,this.config.eventsSelector,t))})}),window.twttr&&window.twttr.ready(t=>{t.events.bind("tweet",()=>{this.sendbeacon({...e,platform:"twitter",action:"share"})}),t.events.bind("follow",()=>{this.sendbeacon({...e,platform:"twitter",action:"follow"})})})}active(e,t,n){const i=n.currentTarget;if(i.matches(e))this.activeElm=i,"function"==typeof t&&t.call(this,n,i);else for(let i=0;i<n.path.length;i++){const o=n.path[i];if(o===this.activeElm){this.activeElm=null;break}if(o instanceof HTMLElement&&o.matches(e)){"function"==typeof t&&t.call(this,n,o);break}}}sendbeacon(e){const t={...this.location,ad2udid:this.udid,serialNumber:this.serialNumber,get timestamp(){return(new Date).getTime()}};let n=Object.assign({},e,t);if(this.constant.devmode)console.log(n);else if("sendBeacon"in navigator)navigator.sendBeacon(this.constant.beaconURL,JSON.stringify(n));else{const e=new XMLHttpRequest;e.open("post",this.constant.beaconURL,!0),e.addEventListener("load",e=>{}),e.send(JSON.stringify(n))}}get constant(){return{beaconURL:"https://cm.ad2iction.com/api/log.php",udidURL:"https://cm.ad2iction.com/api/getID",iframeURL:"https://content.ad2iction.com/lo/cdp/ad2tracker.html",idName:"ad2udid",devmode:!1}}get cookie(){return{set(e,t,n){const i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3);const o="expires="+i.toUTCString();document.cookie=e+"="+t+";"+o+";path=/"},get(e){const t=e+"=",n=document.cookie.split(";");let i="";for(let e=0;e<n.length;e++){let o=n[e];for(;" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(t)){i=o.substring(t.length,o.length);break}}return i}}}get cmd(){return{create(e){this.serialNumber=e[0]},trigger(e){if(-1==this.config.customizeEvt.indexOf(e[0]))return!1;let t={action:e[0]};e[1]&&(t.attachment=e[1]),this.sendbeacon(t)},track(e){const t=this.bindedSelector.split(", ");let n={action:e[1],selector:e[0]},i=null;if(-1!==t.indexOf(e[0]))return!1;e[2]&&(n.attachment=e[2]),this.bindedSelector+=`, ${e[0]}`,document.querySelectorAll(`body, ${e[0]}`).forEach(t=>{t.addEventListener(e[1],function(t){const o=t.currentTarget;if(o.matches(e[0])&&!o.matches(this.config.eventsSelector))i=o,this.sendbeacon({...n,tagName:o.tagName.toLowerCase(),innerText:o.innerText});else for(let o=0;o<t.path.length;o++){const a=t.path[o];if(i==a){i=null;break}if(a instanceof HTMLElement&&a.matches(e[0])&&!a.matches(this.config.eventsSelector)){this.sendbeacon({...n,tagName:a.tagName.toLowerCase(),innerText:a.innerText});break}}}.bind(this))})}}}}window.ad2trk=window.ad2trk||new Ad2Tracker;
